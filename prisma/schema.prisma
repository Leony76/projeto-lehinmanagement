generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id             String     @id @default(cuid())
  name           String?
  email          String     @unique
  password       String?
  emailVerified  Boolean?   @map("email_verified")
  image          String?
  createdAt      DateTime?  @default(now()) @map("created_at")
  updatedAt      DateTime?  @updatedAt @map("updated_at")

  darkTheme      Boolean   @default(false) @map("dark_theme")
  role Role?     @default(CUSTOMER)
  isActive       Boolean    @default(true)

  accounts             Account[]
  sessions             Session[]
  orders               Order[]
  costumerProducts     CostumerProduct[]
  sellerProducts       Product[]

  targetUser           AdminActionHistory[] @relation("AdminTargetUser")
  actor                AdminActionHistory[]  @relation("AdminActor")

  orderHistoryChanged  OrderHistory[]  @relation("OrderHistoryChangedBy")
  orderHistoryDeleted  OrderHistory[]  @relation("OrderHistoryDeletedBy")
  productReview        ProductReview[]
  admin                ProductChangeHistory[]

  @@map("users")
}

model AdminActionHistory {
  id        Int       @id @default(autoincrement())
  action    AdminAction
  createdAt DateTime  @default(now()) @map("created_at")

  actorId   String    @map("actor_id")
  targetUserId String? @map("target_user_id")
  targetProductId Int? @map("target_product_id")
  targetOrderId Int? @map("target_order_id")

  actor     User      @relation("AdminActor", fields: [actorId], references: [id])
  targetUser User?    @relation("AdminTargetUser", fields: [targetUserId], references: [id])
  product   Product? @relation(fields: [targetProductId], references: [id])
  order     Order?   @relation(fields: [targetOrderId], references: [id])

  @@map("admin_action_history")
}

model Session {
  id        String   @id
  expiresAt DateTime
  token     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("session")
}

model Account {
  id                     String    @id
  accountId              String
  providerId             String
  userId                 String
  user                   User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  password               String?
  type                   String?   
  createdAt              DateTime  @default(now())
  updatedAt              DateTime  @updatedAt
  
  accessToken            String?
  refreshToken           String?
  idToken                String?
  accessTokenExpiresAt   DateTime?
  refreshTokenExpiresAt  DateTime?
  scope                  String?

  @@map("account")
}

model Verification {
  id         String     @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime?  @default(now())
  updatedAt  DateTime?  @updatedAt

  @@map("verification")
}


model Order {
  id             Int            @id @default(autoincrement())
  userId         String         @map("user_id")
  total          Decimal
  createdAt      DateTime?      @default(now()) @map("created_at")
  updatedAt      DateTime?      @updatedAt @map("updated_at")
  reservedUntil  DateTime?
  deletedAt      DateTime?      @map("deleted_at")

  deletedByCustomerAt DateTime?
  deletedBySellerAt   DateTime?

  status       OrderStatus         @default(PENDING)

  orderHistory OrderHistory[]
  orderItems   OrderItem[]
  user         User           @relation(fields: [userId], references: [id])
  payments     Payment[]
  costumerProducts CostumerProduct[]
  order AdminActionHistory[]

  @@map("orders")
}

model Product {
  id             Int          @id @default(autoincrement())
  sellerId       String       @map("seller_id")
  name           String
  price          Decimal
  description    String? 
  stock          Int
  reservedStock  Int          @default(0)
  isActive       Boolean      @map("is_active")
  deletedBy      DeletedBy?   @map("deleted_by")
  category       Category
  imageUrl       String       @map("image_url")
  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime?    @updatedAt @map("updated_at")
  deletedAt      DateTime?    @map("deleted_at")

  orderItems     OrderItem[]
  adminActions   AdminActionHistory[]
  seller         User         @relation(fields: [sellerId], references: [id])
  customer       CostumerProduct[]
  reviews        ProductReview[]
  changeHistory  ProductChangeHistory[]

  @@map("products")
}

model ProductChangeHistory {
  id          Int      @id @default(autoincrement())
  productId   Int      @map("product_id")
  adminId     String   @map("admin_id")
  action      ProductAdminAction
  justification String
  createdAt   DateTime @default(now())  @map("created_at")

  product     Product  @relation(fields: [productId], references: [id]) 
  admin       User     @relation(fields: [adminId], references: [id])

  @@map("product_changes_history")
}


model CostumerProduct {
  id Int @id @default(autoincrement())

  costumerId String @map("costumer_id")
  costumerProductId Int @map("costumer_product_id")
  orderId Int @map("order_id")

  createdAt DateTime @default(now()) @map("created_at")
  deletedAt DateTime? @map("deleted_at")

  costumer User @relation(fields: [costumerId], references: [id])
  costumerProduct Product @relation(fields: [costumerProductId], references: [id]) 
  order Order @relation(fields: [orderId], references: [id])

  @@map("costumer_products")
}

model Payment {
  id        Int            @id @default(autoincrement())
  orderId   Int            @map("order_id")
  amount    Decimal
  method    String
  status    PaymentStatus
  createdAt DateTime       @default(now()) @map("created_at")
  order     Order          @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@map("payments")
}

model OrderItem {
  id        Int      @id @default(autoincrement())
  orderId   Int      @map("order_id")
  productId Int      @map("product_id")
  quantity  Int
  price     Decimal
  createdAt DateTime @default(now())

  order     Order    @relation(fields: [orderId], references: [id])
  product   Product  @relation(fields: [productId], references: [id])

  @@map("order_items")
}

model OrderHistory {
  id               Int          @id @default(autoincrement())
  orderId          Int          @map("order_id")

  rejectionJustify String?      @map("rejection_justify")
  message          String?
  changedById      String       @map("changed_by")
  deletedById      String?      @map("deleted_by_id")

  createdAt        DateTime     @default(now()) @map("created_at")
  deletedAt        DateTime?    @map("deleted_at")

  status           OrderStatus
  changedBy        User         @relation("OrderHistoryChangedBy", fields: [changedById], references: [id])
  deletedBy        User?        @relation("OrderHistoryDeletedBy", fields: [deletedById], references: [id])
  order            Order        @relation(fields: [orderId], references: [id])

  @@map("order_history")
}

model ProductReview {
  id         Int       @id @default(autoincrement())
  rating     Int
  comment    String?
  productId  Int       @map("product_id")
  userId     String    @map("user_id")
  createdAt  DateTime  @default(now()) @map("created_at")

  product    Product   @relation(fields: [productId], references: [id])
  user       User      @relation(fields: [userId], references: [id])

  @@unique([productId, userId], name: "productId_userId")
  @@map("product_reviews")
}

enum Role {
  ADMIN
  SELLER
  CUSTOMER
}

enum Category {
  TOY
  CLOTHING
  ELECTRONIC
  HYGIENE
  COSMETIC
  APPLIANCE
  SPORT
  DECORATION
  CLEANING
  KITCHEN
  HANDMADE
}

enum PaymentStatus {
  APPROVED
  REJECTED
}

enum OrderStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELED
}

enum DeletedBy {
  CUSTOMER
  SELLER
  ADMIN
}

enum PaymentMethods {
  CREDIT_CARD
  DEBIT_CARD
  BANK_SLIP
  PIX
}

enum AdminAction {
  USER_DEACTIVATED
  USER_ACTIVATED
  PRODUCT_REMOVED
  PRODUCT_EDITED
  ORDER_CANCELED
  PAYMENT_REFUNDED
}

enum ProductAdminAction {
  EDITED
  DELETED
  BLOCKED
  UNBLOCKED
}

